<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>SQRL | Simple Counters </title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/sqrl/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/sqrl/images/favicon.ico">

    

  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"title":"Simple Counters","path":"counters/simple.html"},"data":{"navigation":{"logo":{"text":"SQRL Documentation","type":"link","path":"index.html"},"main":[{"text":"Introduction","type":"link","path":"index.html"},{"text":"Motivation","type":"link","path":"motivation.html"},{"text":"Tutorial","type":"link","path":"tutorial.html"},{"text":"Why is it unique?","type":"link","path":"unique.html"},{"text":"FAQ","type":"link","path":"faq.html"},{"text":"Examples","type":"label","children":[{"text":"Redis Database","type":"link","path":"examples/redis.html"},{"text":"REPL","type":"link","path":"examples/repl.html"},{"text":"Wikipedia","type":"link","path":"examples/wikipedia.html"}]},{"text":"Concepts","type":"label","children":[{"text":"Entities","type":"link","path":"language/entities.html"},{"text":"Labels","type":"link","path":"language/labels.html"},{"text":"Simple Counters","type":"link","path":"counters/simple.html"},{"text":"Unique Counters","type":"link","path":"counters/unique.html"},{"text":"Rate limiters","type":"link","path":"counters/ratelimit.html"},{"text":"Sessionization","type":"link","path":"counters/session.html"},{"text":"Text Pattern Matching","type":"link","path":"language/textpattern.html"},{"text":"Include and Where Clauses","type":"link","path":"language/where.html"},{"text":"Cost Optimisation","type":"link","path":"language/cost.html"}]},{"text":"Standard Library","type":"label","children":[{"text":"Assert Functions","type":"link","path":"stdlib/assert.html"},{"text":"Bool Functions","type":"link","path":"stdlib/bool.html"},{"text":"Control Functions","type":"link","path":"stdlib/control.html"},{"text":"Data Functions","type":"link","path":"stdlib/data.html"},{"text":"Date-time Functions","type":"link","path":"stdlib/date-time.html"},{"text":"Entity Functions","type":"link","path":"stdlib/entity.html"},{"text":"List Functions","type":"link","path":"stdlib/list.html"},{"text":"Math Functions","type":"link","path":"stdlib/math.html"},{"text":"String Functions","type":"link","path":"stdlib/string.html"},{"text":"Type Functions","type":"link","path":"stdlib/type.html"}]},{"text":"Function Packages","type":"label","children":[{"text":"sqrl-cli-functions","type":"link","path":"packages/sqrl-cli-functions.html"},{"text":"sqrl-load-functions","type":"link","path":"packages/sqrl-load-functions.html"},{"text":"sqrl-redis-functions","type":"link","path":"packages/sqrl-redis-functions.html"},{"text":"sqrl-text-functions","type":"link","path":"packages/sqrl-text-functions.html"}]},{"text":"Defining Functions","type":"label","children":[{"text":"Simple Functions","type":"link","path":"functions/simple.html"},{"text":"Statements","type":"link","path":"functions/statement.html"},{"text":"When Clauses","type":"link","path":"functions/when.html"},{"text":"Custom Functions","type":"link","path":"functions/custom.html"}]},{"text":"Production Deployments","type":"label","children":[{"text":"Sync and Async","type":"link","path":"deployment/async.html"},{"text":"Http Server","type":"link","path":"deployment/server.html"},{"text":"Queues","type":"link","path":"deployment/queue.html"}]},{"text":"External Resources","type":"label"},{"text":"API Reference","type":"link","path":"reference/globals.html"},{"text":"Discord Chat","type":"link","path":"https://discord.gg/mMJwWT6"},{"text":"View on GitHub","type":"link","path":"https://github.com/sqrl-lang/sqrl"}]}},"config":{"timezone":"UTC","root":"/sqrl/","time_format":"HH:mm:ss","theme":"sqrl-hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot=""><nav class="doc-navbar"><a href="/sqrl/index.html" class="doc-navbar__logo"><img src="/sqrl/images/logo.png" class="doc-navbar__logo__img"/><span class="doc-navbar__logo__text">SQRL Documentation</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <html><head></head><body><h1 id="Simple-Counters"><a href="#Simple-Counters" class="headerlink" title="Simple Counters"></a>Simple Counters</h1><p>Another powerful tool at your disposal is the ability to flexibly count across multiple timespans. Let’s get started with a simple count.</p>
<h2 id="Your-first-counter"><a href="#Your-first-counter" class="headerlink" title="Your first counter"></a>Your first counter</h2><p>Here’s an example of a simple counter that counts the number of action by a given User in the last week.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LET User := input();</span><br><span class="line">LET NumMessages := count(BY User LAST WEEK);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Pairwise-features"><a href="#Pairwise-features" class="headerlink" title="Pairwise features"></a>Pairwise features</h2><p>You can create a counter by one or more features. In the above example for each unique <strong>User</strong> we have created another counter of the number of actions performed in the last week.</p>
<p>For certain use cases you’ll want to count pairwise features. Perhaps you’ll want to know the number of messages the given user sent on this <strong>Ip</strong> as compared to the number they have sent total. That is easy to do just by comma separating the features.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LET Ip := input();</span><br><span class="line">LET User := input();</span><br><span class="line">LET NumMessages := count(BY User LAST HOUR);</span><br><span class="line">LET NumIpMessages := count(BY User, Ip LAST HOUR);</span><br><span class="line">LET PercentMessagesByIp := 100 * (NumIpMessages / NumMessages);</span><br></pre></td></tr></tbody></table></figure>


<h2 id="Available-timespans"><a href="#Available-timespans" class="headerlink" title="Available timespans"></a>Available timespans</h2><p>The LAST clause specifies the timespan we want to count by. For simple counters we do not allow custom timespans, even though we do for unique counts.</p>
<p>The list of available timespans are:</p>
<ul>
<li>TOTAL</li>
<li>LAST MONTH</li>
<li>LAST TWO WEEKS</li>
<li>LAST EIGHT DAYS</li>
<li>LAST TWO DAYS</li>
<li>LAST DAY</li>
<li>LAST HOUR</li>
</ul>
<p><strong>Note:</strong> <em>TOTAL</em> counts will still expire after 90 days if they have not been seen for that period.</p>
<h2 id="Conditions"><a href="#Conditions" class="headerlink" title="Conditions"></a>Conditions</h2><p>It is very easy to create more interesting counters by passing in a WHERE statement as well.</p>
<p>Let’s imagine you were interested in tracking users who had a high percentage of messages with profanity. We could easily accomplish this by tracking two counts.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># You could use `patternMatch` for a more powerful profanity filter</span><br><span class="line">LET TextWithStrongProfanity := regexMatch('\\b(shit)\\b', Text);</span><br><span class="line"></span><br><span class="line">LET NumMessagesWithProfanity := count(BY User WHERE TextWithStrongProfanity LAST WEEK);</span><br><span class="line">LET NumMessagesWithoutProfanity := count(BY User WHERE NOT TextWithStrongProfanity LAST WEEK); </span><br></pre></td></tr></tbody></table></figure>

<p>Here we have set up two counters – <code>NumMessagesWithProfanity</code> will be increased when the text contains profanity, otherwise <code>NumMessagesWithoutProfanity</code> will be increased. Both counters are available to be read on every action.</p>
<h3 id="Restrictions-on-conditions-in-WHERE-clauses"><a href="#Restrictions-on-conditions-in-WHERE-clauses" class="headerlink" title="Restrictions on conditions in WHERE clauses"></a>Restrictions on conditions in WHERE clauses</h3><p>For reasons discussed under where expressions in our advanced documentation there are strict restrictions on what you can put in a WHERE clause. Anything other than simple equality, <strong>AND</strong>, <strong>OR</strong>, and <strong>NOT</strong> is not allowed.</p>
<p>Since <code>ActorAgeDays &lt; 10</code> is invalid inside a counter where statement, if you wanted to only count messages by new actors you’ll need to create another feature.</p>
<p>The example below creates IsYoungActor and uses that in order to count how many messages were sent on the current ip address by users created in the last ten days.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LET IsYoungActor := ActorAgeDays &lt; 10;</span><br><span class="line">LET NumMessagesByYoungActorsOnIp := count(BY Ip WHERE IsYoungActor);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Labeling-users-that-use-a-high-percentage-of-profanity"><a href="#Labeling-users-that-use-a-high-percentage-of-profanity" class="headerlink" title="Labeling users that use a high percentage of profanity"></a>Labeling users that use a high percentage of profanity</h3><p>To tie it all together we could create a rule for flagging users who have a high percentage of messages containing profanity.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LET NumMessagesWithProfanity := count(BY User WHERE TextWithStrongProfanity LAST WEEK);</span><br><span class="line">LET NumMessagesWithoutProfanity := count(BY User WHERE NOT TextWithStrongProfanity LAST WEEK);</span><br><span class="line"></span><br><span class="line"># Keep track of total and percentage so we can use in reason string.</span><br><span class="line">LET TotalMessages := NumMessagesWithProfanity + NumMessagesWithoutProfanity;</span><br><span class="line">LET PercentProfaneMessages := NumMessagesWithProfanity / TotalMessages;</span><br><span class="line">CREATE RULE HighPercentageProfanity</span><br><span class="line">  WHERE PercentProfaneMessages &gt; 0.5 AND TotalMessages &gt; 2;</span><br><span class="line">  </span><br><span class="line">WHEN HighPercentageProfanity THEN blockAction(), addLabel(User, "bad_user");</span><br></pre></td></tr></tbody></table></figure>

<p>We could just have easily tracked users who received lots of profane messages and either block the action or label the recipient to trigger some form of outreach. Let’s look at what that code would look like:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LET NumReceivedWithProfanity := count(BY Target WHERE TextWithStrongProfanity LAST WEEK);</span><br><span class="line">LET NumReceivedWithoutProfanity := count(BY Target WHERE NOT TextWithStrongProfanity LAST WEEK);</span><br><span class="line"></span><br><span class="line"># Keep track of total and percentage so we can use in reason string.</span><br><span class="line">LET TotalReceived := NumReceivedWithProfanity + NumReceivedWithoutProfanity;</span><br><span class="line">LET PercentProfaneReceived := NumReceivedWithProfanity / TotalReceived;</span><br><span class="line">CREATE RULE HighPercentageProfanityReceived</span><br><span class="line">  WHERE PercentProfaneReceived &gt; 0.5 AND TotalReceived &gt; 2;</span><br><span class="line">  </span><br><span class="line">WHEN HighPercentageProfanityReceived THEN</span><br><span class="line">  blockAction(),</span><br><span class="line">  addLabel(Target, "harassment_recipient");</span><br></pre></td></tr></tbody></table></figure></body></html>
        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/sqrl/script/doc.js"></script>

    

  </body>
</html>
